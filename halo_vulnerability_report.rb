require_relative 'lib/helper'
require 'csv'
require 'time'

# Generate SVA Report
class SvaReport
  def initialize
    @sc = ServersController.new
    @cc = CveController.new
  end

  def filename(data)
    "reports/#{Time.now.utc.iso8601}_#{data.first[:accountID]}.csv"
  end

  def write_to_csv(data)
    headers = data.first.keys
    CSV.open(filename(data), 'w', headers: headers) do |csv|
      csv << headers.map(&:to_s)
      data.each { |h| csv << h.values }
    end
  end

  def make_report(account_id)
    servers = @sc.filtered_servers(account_id)
    reports = []
    servers.each do |srv|
      report = @cc.build_whitelisted(srv, @sc.show("#{srv['id']}/svm"))
      reports << report
    end

    reports.flatten!
    write_to_csv(reports) unless reports.empty?
  end
end

SvaReport.new.make_report(Options.val[:aws_id])
